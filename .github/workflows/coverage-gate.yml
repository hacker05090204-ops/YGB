# CI/CD Coverage Enforcement Workflow
#
# Triggers on push/PR to main.
# Fails if Python coverage <95%, C++ coverage <85%, or JS/TS coverage <80%.
# Prints all coverage values explicitly before failing.
# Branch protection: require status checks before merge.

name: Coverage Gate

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  coverage-gate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install system dependencies
        run: |
          sudo apt-get update -q
          sudo apt-get install -y gcovr g++

      - name: Install Python dependencies
        run: |
          pip install pytest pytest-cov coverage gcovr
          pip install -r requirements.txt || true

      # ========== PYTHON COVERAGE ==========
      - name: Python coverage check (>=95%)
        id: python_cov
        continue-on-error: true
        run: |
          echo "=== PYTHON COVERAGE ==="
          python -m pytest backend/tests/ \
            --cov=backend \
            --cov-report=xml:coverage_python.xml \
            --cov-report=json:coverage_python.json \
            --cov-report=term-missing \
            -v --tb=short
          echo "---"
          coverage report || true

      # ========== C++ COVERAGE ==========
      - name: Compile C++ with coverage flags
        id: cpp_build
        continue-on-error: true
        run: |
          echo "=== C++ COVERAGE BUILD ==="
          mkdir -p build_coverage
          # Compile all native .cpp files with self-tests enabled
          for src in $(find native/ -name '*.cpp' -type f); do
            name=$(basename "$src" .cpp)
            dir=$(dirname "$src")
            echo "Compiling: $src"
            g++ -std=c++17 -O0 --coverage -fprofile-arcs -ftest-coverage \
              -DRUN_SELF_TESTS \
              -o "build_coverage/${name}" "$src" 2>/dev/null || \
              echo "  WARN: $src did not compile standalone (expected for includes)"
          done

      - name: Run C++ self-tests
        id: cpp_test
        continue-on-error: true
        run: |
          echo "=== C++ SELF-TESTS ==="
          cd build_coverage
          for bin in *; do
            if [ -x "$bin" ]; then
              echo "Running: $bin"
              ./"$bin" || echo "  WARN: $bin returned non-zero"
            fi
          done

      - name: C++ coverage report
        id: cpp_cov
        continue-on-error: true
        run: |
          echo "=== C++ COVERAGE ==="
          gcovr -r . \
            --filter native/ \
            --exclude-directories=backend \
            --json coverage_cpp.json \
            --print-summary || echo "gcovr failed â€” no coverage data"

      # ========== JS/TS COVERAGE ==========
      - name: JS/TS coverage check (>=80%)
        id: js_cov
        continue-on-error: true
        run: |
          echo "=== JS/TS COVERAGE ==="
          cd frontend
          npm ci
          npm test -- --coverage 2>&1 || true
          cat coverage/coverage-summary.json 2>/dev/null || echo "No JS/TS coverage data"

      # ========== FINAL GATE ==========
      - name: Print all coverage values
        run: |
          echo "============================================"
          echo "        COVERAGE SUMMARY"
          echo "============================================"

          echo ""
          echo "=== PYTHON COVERAGE ==="
          if [ -f coverage_python.json ]; then
            python3 -c "
          import json
          with open('coverage_python.json') as f:
              d = json.load(f)
          pct = d.get('totals', {}).get('percent_covered', 0)
          print(f'  Python: {pct:.1f}% (threshold: 95%)')
          print(f'  Status: {\"PASS\" if pct >= 95 else \"FAIL\"}')" || echo "  Python: could not parse"
          else
            echo "  Python: NO DATA"
          fi

          echo ""
          echo "=== C++ COVERAGE ==="
          if [ -f coverage_cpp.json ]; then
            python3 -c "
          import json
          with open('coverage_cpp.json') as f:
              d = json.load(f)
          lt = d.get('line_total', 0)
          lc = d.get('line_covered', 0)
          pct = (lc/lt*100) if lt > 0 else 0
          print(f'  C++: {pct:.1f}% (threshold: 85%)')
          print(f'  Status: {\"PASS\" if pct >= 85 else \"FAIL\"}')" || echo "  C++: could not parse"
          else
            echo "  C++: NO DATA (compile or gcovr failed)"
          fi

          echo ""
          echo "=== JS/TS COVERAGE ==="
          if [ -f frontend/coverage/coverage-summary.json ]; then
            python3 -c "
          import json
          with open('frontend/coverage/coverage-summary.json') as f:
              d = json.load(f)
          pct = d.get('total', {}).get('lines', {}).get('pct', 0)
          print(f'  JS/TS: {pct:.1f}% (threshold: 80%)')
          print(f'  Status: {\"PASS\" if pct >= 80 else \"FAIL\"}')" || echo "  JS/TS: could not parse"
          else
            echo "  JS/TS: NO DATA"
          fi

          echo ""
          echo "============================================"

      - name: Run coverage gate script
        run: python scripts/coverage_gate.py

      - name: Upload coverage artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-reports
          path: |
            coverage_python.json
            coverage_python.xml
            coverage_cpp.json
            frontend/coverage/
            reports/coverage_report.json

  governance-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install -r requirements.txt || true

      - name: Governance lock verification
        run: python -m backend.tests.test_governance_lock

      - name: Full pipeline integration
        run: python -m backend.tests.test_full_pipeline

      - name: Error path coverage
        run: python -m backend.tests.test_error_paths

      - name: Parallel scheduler stress
        run: python -m backend.tests.test_parallel_scheduler_stress
