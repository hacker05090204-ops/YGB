"""
exploit_stability_test.py — Exploit Stability Testing (Phase 3)

Re-evaluate older known exploits.
If detection drops → flag regression.
"""

import logging
from dataclasses import dataclass
from datetime import datetime
from typing import Callable, Dict, List, Optional

import numpy as np

logger = logging.getLogger(__name__)

REGRESSION_THRESHOLD = 0.05  # 5% drop


@dataclass
class ExploitTestResult:
    """Result for a single known exploit."""
    exploit_id: str
    previous_score: float
    current_score: float
    delta: float
    regressed: bool


@dataclass
class StabilityReport:
    """Overall exploit stability report."""
    stable: bool
    total_tested: int
    regressions: int
    results: List[ExploitTestResult]
    timestamp: str = ""


class ExploitStabilityTester:
    """Tests model stability on known exploits.

    Re-evaluates detection scores.
    Flags any regression > 5%.
    """

    def __init__(self, threshold: float = REGRESSION_THRESHOLD):
        self.threshold = threshold
        self._known: Dict[str, float] = {}

    def register_known(self, exploit_id: str, baseline_score: float):
        """Register a known exploit with baseline detection score."""
        self._known[exploit_id] = baseline_score

    def test(
        self,
        score_fn: Callable,
    ) -> StabilityReport:
        """Test all known exploits.

        Args:
            score_fn: callable(exploit_id) → current detection score
        """
        results = []
        regressions = 0

        for eid, baseline in self._known.items():
            try:
                current = score_fn(eid)
            except Exception:
                current = 0.0

            delta = current - baseline
            regressed = delta < -self.threshold

            results.append(ExploitTestResult(
                exploit_id=eid,
                previous_score=baseline,
                current_score=current,
                delta=round(delta, 4),
                regressed=regressed,
            ))

            if regressed:
                regressions += 1
                logger.warning(
                    f"[EXPLOIT_STABILITY] ✗ {eid}: "
                    f"{baseline:.4f}→{current:.4f} (Δ={delta:+.4f})"
                )

        stable = regressions == 0

        report = StabilityReport(
            stable=stable,
            total_tested=len(results),
            regressions=regressions,
            results=results,
            timestamp=datetime.now().isoformat(),
        )

        icon = "✓" if stable else "✗"
        logger.info(
            f"[EXPLOIT_STABILITY] {icon} "
            f"{len(results)} tested, {regressions} regressions"
        )
        return report

    @property
    def known_count(self) -> int:
        return len(self._known)
